# Kamal Configuration for NBM Backend API
service: nbm-be
image: desinghrajan/nbm-be

# Primary domain (same as frontend)
primary_role: web

# Docker registry authentication
registry:
  username: desinghrajan
  password:
    - KAMAL_REGISTRY_PASSWORD

# Servers to deploy to
servers:
  web:
    hosts:
      - 139.84.158.2

# PostgreSQL database accessory
accessories:
  postgres:
    image: postgres:16-alpine
    host: 139.84.158.2
    port: 5432
    env:
      clear:
        POSTGRES_USER: nbm_user
        POSTGRES_DB: nbm_be_production
      secret:
        - POSTGRES_PASSWORD
    directories:
      - data:/var/lib/postgresql/data
    options:
      health-cmd: "pg_isready -U nbm_user"
      health-interval: 10s
      health-timeout: 5s
      health-retries: 5

# Environment variables for the application
env:
  clear:
    PORT: 8000
    NODE_ENV: production
    ENVIRONMENT: production
    JWT_ISSUER: tonystack
    JWT_EXPIRY: 7d
    ALLOWED_ORIGINS: https://neverbeforemarketing.com
    LOG_LEVEL: info
    SUPERADMIN_EMAIL: admin@nbm.com
    ALPHA_EMAIL: alpha@nbm.com
    ALPHA_USERNAME: Alpha User
  secret:
    - DATABASE_URL
    - JWT_SECRET
    - SUPERADMIN_PASSWORD
    - ALPHA_PASSWORD

# SSH configuration
ssh:
  user: root

# Use existing kamal-proxy from frontend deployment
# Path-based routing: /nbm-be/api/* routes to this backend
# IMPORTANT: Manual proxy registration required after deployment
#
# Kamal's default proxy config doesn't support path-prefix without stripping,
# so we skip automatic registration and do it manually via hook
proxy:
  # Skip kamal-proxy automatic registration (we'll do it manually)
  host: neverbeforemarketing.com
  ssl: false
  app_port: 8000
  forward_headers: true
  response_timeout: 60
  buffering:
    requests: true
    responses: true
  healthcheck:
    path: /health
    timeout: 120
    interval: 10

# Build configuration
builder:
  arch: amd64
  cache:
    type: registry
    options: mode=max

# Deployment hooks - automate proxy registration
hooks:
  post-deploy: |
    # Remove old proxy registration
    docker exec kamal-proxy kamal-proxy remove nbm-be-web || true
    
    # Get the new container ID
    CONTAINER_ID=$(docker ps -q -f name=nbm-be-web -f status=running | head -1)
    
    # Register with kamal-proxy (preserve path prefix)
    docker exec kamal-proxy kamal-proxy deploy nbm-be-web \
      --target="${CONTAINER_ID}:8000" \
      --host=neverbeforemarketing.com \
      --path-prefix=/nbm-be/api \
      --strip-path-prefix=false \
      --health-check-path=/health \
      --health-check-interval=10s \
      --health-check-timeout=120s \
      --target-timeout=60s
    
    echo "âœ… Proxy registered for nbm-be-web at /nbm-be/api"

# Asset path (not needed for API, but good to have)
# asset_path: /app/public

# Volumes (if needed for logs or uploads)
# volumes:
#   - "./storage:/app/storage"

# Run migrations after deployment
# Will be executed using kamal app exec
# Example: kamal app exec 'deno run --allow-all scripts/migrate-run.ts'
