# Kamal Configuration for NBM Backend API
service: nbm-be
image: desinghrajan/nbm-be

# Primary domain (same as frontend)
primary_role: web

# Docker registry authentication
registry:
  username: desinghrajan
  password:
    - KAMAL_REGISTRY_PASSWORD

# Servers to deploy to
servers:
  web:
    hosts:
      - 139.84.158.2

# PostgreSQL database accessory
accessories:
  postgres:
    image: postgres:16-alpine
    host: 139.84.158.2
    port: 5432
    env:
      clear:
        POSTGRES_USER: nbm_user
        POSTGRES_DB: nbm_be_production
      secret:
        - POSTGRES_PASSWORD
    directories:
      - data:/var/lib/postgresql/data
    options:
      health-cmd: "pg_isready -U nbm_user"
      health-interval: 10s
      health-timeout: 5s
      health-retries: 5

# Environment variables for the application
env:
  clear:
    PORT: 8000
    NODE_ENV: production
    ENVIRONMENT: production
    JWT_ISSUER: tonystack
    JWT_EXPIRY: 7d
    ALLOWED_ORIGINS: https://neverbeforemarketing.com
    LOG_LEVEL: info
    SUPERADMIN_EMAIL: admin@nbm.com
    ALPHA_EMAIL: alpha@nbm.com
    ALPHA_USERNAME: Alpha User
  secret:
    - DATABASE_URL
    - JWT_SECRET
    - SUPERADMIN_PASSWORD
    - ALPHA_PASSWORD

# SSH configuration
ssh:
  user: root

# Proxy configuration for path-based routing
# Routes /nbm-be/api/* to this service (strips prefix by default)
proxy:
  host: neverbeforemarketing.com
  path_prefix: /nbm-be/api
  ssl: false
  app_port: 8000
  forward_headers: true
  response_timeout: 60
  healthcheck:
    path: /health
    interval: 10
    timeout: 120
  buffering:
    requests: true
    responses: true

# Build configuration
builder:
  arch: amd64
  cache:
    type: registry
    options: mode=max
